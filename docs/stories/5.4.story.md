# Story 5.4: User Notification Preferences & Control

**Status:** Draft

## Story Statement
As a user,
I want to control the notifications I receive,
so that I can manage my communication preferences.

## Acceptance Criteria
- User can enable or disable direct notifications from a business they follow, without unfollowing the business.
- User can set preferences for the frequency and type of promotional ads (e.g., only "hot offers," exclude certain categories).
- The notification system throttles or groups similar notifications based on industry best practices.
- The platform owner has the option to change the notification throttling and grouping settings dynamically.
- BusinessFollows table receive_notifications flag is updated.
- Users table privacy_settings JSONB field stores granular notification preferences for ad/promotion types.
- Local Testability: API endpoint PUT /api/users/{user_id}/notifications/preferences updates notification settings. Verification by querying SELECT receive_notifications FROM public.BusinessFollows WHERE user_id = '{user_id}' AND business_id = '{business_id}' and SELECT privacy_settings FROM public.Users WHERE user_id = '{user_id}'.

## Dev Notes
### Previous Story Insights
- Real-time social and activity notifications are in place. [Source: docs/stories/5.3.story.md]

### Data Models
- BusinessFollows table: receive_notifications flag. [Source: PRD]
- Users table: privacy_settings JSONB field for notification preferences. [Source: PRD]

### API Specifications
- PUT /api/users/{user_id}/notifications/preferences: Updates notification settings. [Source: PRD]
- All API interactions must go through frontend API service layer (`apps/web/src/api/`). [Source: architecture/coding-standards.md]

### Component Specifications
- Notification preferences UI: Enable/disable business notifications, set ad/promotion frequency/type, group/throttle settings. [Source: PRD]
- Admin UI for platform owner to adjust throttling/grouping. [Source: PRD]

### File Locations
- Frontend pages: `apps/web/src/pages/notification-preferences.tsx`, `apps/web/src/pages/admin-notification-settings.tsx`
- API service: `apps/web/src/api/notification-preferences.ts`, `apps/web/src/api/admin-notification-settings.ts`
- Backend: `apps/api/src/users/`, `apps/api/src/admin/` (serverless functions for notification preferences and admin controls)
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Frontend: Unit and integration tests for notification preferences UI. [Source: architecture/testing-strategy.md]
- Backend: Unit and integration tests for notification preferences endpoints. [Source: architecture/testing-strategy.md]
- E2E: Playwright/Cypress tests for notification preferences and admin controls. [Source: architecture/testing-strategy.md]

### Technical Constraints
- TypeScript for all codebases. [Source: architecture/tech-stack.md]
- Follow coding standards for API service layer, error handling, and naming conventions. [Source: architecture/coding-standards.md]
- State management for notification preferences via React Context API/Zustand/Jotai. [Source: architecture/tech-stack.md]
- Notification throttling/grouping must be flexible and efficient. [Source: PRD]

## Tasks / Subtasks
1. Implement notification preferences UI for users. [Source: PRD]
2. Implement backend endpoint for updating notification preferences. [Source: PRD]
3. Store and retrieve notification preferences in BusinessFollows and Users tables. [Source: PRD]
4. Implement admin UI and backend for adjusting throttling/grouping. [Source: PRD]
5. Add validation and error handling for preferences and admin controls. [Source: architecture/coding-standards.md]
6. Write unit/integration tests for frontend notification preferences and admin UI. [Source: architecture/testing-strategy.md]
7. Write unit/integration tests for backend notification preferences and admin endpoints. [Source: architecture/testing-strategy.md]
8. Write E2E tests for notification preferences and admin controls. [Source: architecture/testing-strategy.md]
9. Verify all file locations and naming conventions match unified project structure. [Source: architecture/unified-project-structure.md]

## Project Structure Notes
- All files should be placed according to the unified project structure. [Source: architecture/unified-project-structure.md]
- No conflicts found between epic requirements and unified project structure.

---

Checklist: To be completed after draft review.
- [ ] All acceptance criteria addressed
- [ ] All technical context referenced
- [ ] Tasks/subtasks are actionable and referenced
- [ ] Project structure alignment verified
- [ ] Ready for developer implementation 