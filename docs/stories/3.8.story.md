# Story 3.8: Driver Status Calculation & Display

**Status:** Approved


## Story Statement
As a user,
I want my activities to contribute to a "Driver" status,
so that I can achieve privileged recognition and access exclusive benefits.

## Acceptance Criteria
- The system calculates a user's "Driver" status based on coupon collections, sharing coupons, business check-ins, review writing, business recommendations (to friends), and ad/top product interactions.
- All specified activities (collections, sharing, check-ins, reviews, recommendations, ad/product interactions) contribute equally to "Driver" status calculation by default.
- Users who fall within the top 10% of active users in their city (based on these metrics) are marked as "Drivers".
- A "shining gold ring Driverâ€™s avatar" is displayed on the user's profile to indicate their privileged status.
- The platform owner can dynamically change the weightage of each metric used for "Driver" status calculation.
- Users table is_driver flag and driver_score are updated periodically.
- Local Testability: A serverless function (e.g., cron-job) triggers the Driver calculation logic. Verification by executing the function and checking is_driver and driver_score for sample users in the Users table.

## Dev Notes
### Previous Story Insights
- All user activity types (coupon collection, sharing, check-ins, reviews, recommendations, ad/product interactions) are tracked. [Source: docs/stories/3.1.story.md - 3.7.story.md]

### Data Models
- Users table: is_driver flag, driver_score. [Source: PRD]
- UserActivities table: activity_type, entity_id, activity_data. [Source: PRD]

### API Specifications
- Serverless function (cron-job) to calculate Driver status and update users. [Source: PRD]
- GET /api/users/{user_id}/driver-status: Retrieve Driver status and score. [Source: PRD]
- All API interactions must go through frontend API service layer (`apps/web/src/api/`). [Source: architecture/coding-standards.md]

### Component Specifications
- Driver status indicator (gold ring avatar) on user profile. [Source: PRD]
- Admin UI for adjusting metric weightage. [Source: PRD]
- User dashboard display of Driver status and score. [Source: PRD]

### File Locations
- Frontend pages: `apps/web/src/pages/profile.tsx`, `apps/web/src/pages/dashboard.tsx`, `apps/web/src/pages/admin-driver-settings.tsx`
- API service: `apps/web/src/api/driver-status.ts`, `apps/web/src/api/admin-driver-settings.ts`
- Backend: `apps/api/src/users/`, `apps/api/src/admin/` (serverless functions for Driver calculation and admin controls)
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Frontend: Unit and integration tests for Driver status display and admin UI. [Source: architecture/testing-strategy.md]
- Backend: Unit and integration tests for Driver calculation and status endpoints. [Source: architecture/testing-strategy.md]
- E2E: Playwright/Cypress tests for Driver status calculation, display, and admin controls. [Source: architecture/testing-strategy.md]

### Technical Constraints
- TypeScript for all codebases. [Source: architecture/tech-stack.md]
- Follow coding standards for API service layer, error handling, and naming conventions. [Source: architecture/coding-standards.md]
- State management for Driver status via React Context API/Zustand/Jotai. [Source: architecture/tech-stack.md]
- Driver calculation must be efficient and scalable for periodic execution. [Source: PRD]

## Tasks / Subtasks
1. Implement serverless function (cron-job) for Driver status calculation and user updates. [Source: PRD]
2. Implement backend endpoints for retrieving Driver status and updating metric weightage. [Source: PRD]
3. Store and update Driver status and score in Users table. [Source: PRD]
4. Implement Driver status indicator (gold ring avatar) on user profile. [Source: PRD]
5. Implement admin UI for adjusting metric weightage. [Source: PRD]
6. Display Driver status and score on user dashboard. [Source: PRD]
7. Add validation and error handling for Driver calculation and admin controls. [Source: architecture/coding-standards.md]
8. Write unit/integration tests for frontend Driver status display and admin UI. [Source: architecture/testing-strategy.md]
9. Write unit/integration tests for backend Driver calculation and status endpoints. [Source: architecture/testing-strategy.md]
10. Write E2E tests for Driver status calculation, display, and admin controls. [Source: architecture/testing-strategy.md]
11. Verify all file locations and naming conventions match unified project structure. [Source: architecture/unified-project-structure.md]

## Project Structure Notes
- All files should be placed according to the unified project structure. [Source: architecture/unified-project-structure.md]
- No conflicts found between epic requirements and unified project structure.

---

Checklist: To be completed after draft review.
- [ ] All acceptance criteria addressed
- [ ] All technical context referenced
- [ ] Tasks/subtasks are actionable and referenced
- [ ] Project structure alignment verified
- [ ] Ready for developer implementation 