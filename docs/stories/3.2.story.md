# Story 3.2: User Coupon Discovery & Collection

**Status:** Approved

## Story Statement
As a user,
I want to discover available coupons from businesses and add them to my digital wallet,
so that I can manage my savings.

## Acceptance Criteria
- User can browse and search for coupons from business storefronts or a dedicated coupon discovery section.
- User can add available digital coupons to their personal coupon wallet.
- The digital coupon wallet displays collected coupons.
- UserCoupons table stores coupon_id, user_id, unique_code, collected_at.
- Local Testability: API endpoint POST /api/users/{user_id}/coupons/collect adds a coupon to user's wallet. Verification by querying SELECT * FROM public.UserCoupons WHERE user_id = '{user_id}' AND coupon_id = '{coupon_id}'.

## Dev Notes
### Previous Story Insights
- Business offers and coupon creation are in place. [Source: docs/stories/3.1.story.md]

### Data Models
- Coupons table: coupon_id, offer_id, business_id, value, start_date, end_date, total_quantity, cost_per_coupon. [Source: PRD]
- UserCoupons table: coupon_id, user_id, unique_code, collected_at. [Source: PRD]

### API Specifications
- GET /api/coupons: Retrieves available coupons for discovery. [Source: PRD]
- POST /api/users/{user_id}/coupons/collect: Adds a coupon to user's wallet. [Source: PRD]
- GET /api/users/{user_id}/coupons: Retrieves user's collected coupons. [Source: PRD]
- All API interactions must go through frontend API service layer (`apps/web/src/api/`). [Source: architecture/coding-standards.md]

### Component Specifications
- Coupon discovery/browse/search interface. [Source: PRD]
- Coupon wallet UI for displaying collected coupons. [Source: PRD]
- Add-to-wallet button for available coupons. [Source: PRD]

### File Locations
- Frontend pages: `apps/web/src/pages/coupon-discovery.tsx`, `apps/web/src/pages/coupon-wallet.tsx`
- API service: `apps/web/src/api/coupons.ts`, `apps/web/src/api/user-coupons.ts`
- Backend: `apps/api/src/coupons/`, `apps/api/src/users/` (serverless functions for coupon discovery and wallet)
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Frontend: Unit and integration tests for coupon discovery, add-to-wallet, and wallet display. [Source: architecture/testing-strategy.md]
- Backend: Unit and integration tests for coupon discovery and collection endpoints. [Source: architecture/testing-strategy.md]
- E2E: Playwright/Cypress tests for coupon discovery and wallet flows. [Source: architecture/testing-strategy.md]

### Technical Constraints
- TypeScript for all codebases. [Source: architecture/tech-stack.md]
- Follow coding standards for API service layer, error handling, and naming conventions. [Source: architecture/coding-standards.md]
- State management for coupons/wallet via React Context API/Zustand/Jotai. [Source: architecture/tech-stack.md]

## Tasks / Subtasks
1. Implement coupon discovery/browse/search interface. [Source: PRD]
2. Implement add-to-wallet button for available coupons. [Source: PRD]
3. Implement coupon wallet UI for displaying collected coupons. [Source: PRD]
4. Implement backend endpoints for coupon discovery and collection. [Source: PRD]
5. Store and retrieve coupon data in Coupons and UserCoupons tables. [Source: PRD]
6. Add validation and error handling for coupon collection. [Source: architecture/coding-standards.md]
7. Write unit/integration tests for frontend coupon discovery and wallet. [Source: architecture/testing-strategy.md]
8. Write unit/integration tests for backend coupon endpoints. [Source: architecture/testing-strategy.md]
9. Write E2E tests for coupon discovery and wallet flows. [Source: architecture/testing-strategy.md]
10. Verify all file locations and naming conventions match unified project structure. [Source: architecture/unified-project-structure.md]

## Project Structure Notes
- All files should be placed according to the unified project structure. [Source: architecture/unified-project-structure.md]
- No conflicts found between epic requirements and unified project structure.

---

Checklist: To be completed after draft review.
- [ ] All acceptance criteria addressed
- [ ] All technical context referenced
- [ ] Tasks/subtasks are actionable and referenced
- [ ] Project structure alignment verified
- [ ] Ready for developer implementation 