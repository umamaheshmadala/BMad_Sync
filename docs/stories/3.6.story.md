# Story 3.6: In-Store Coupon Redemption & Auto Check-in

**Status:** Draft

## Story Statement
As a user,
I want to redeem my digital coupons at physical stores,
so that I can avail offers, and my visit is recorded for analytics.

## Acceptance Criteria
- User can present a unique digital coupon code (from UserCoupons.unique_code) for in-store redemption.
- Upon successful redemption, the coupon is marked as 'redeemed' and becomes unusable (single use only).
- The system automatically records a check-in for the user at the business when a coupon is redeemed.
- All data about the redeemed coupon is stored for future references, metrics, and analytics.
- UserCoupons table is_redeemed and redeemed_at are updated.
- UserActivities table is updated with activity_type 'coupon_redeemed' and relevant entity_id (coupon_id, business_id) and activity_data including redeemed_at.
- Upon successful redemption, the user is redirected to the business's storefront with an option to leave a review.
- Local Testability: API endpoint POST /api/business/{business_id}/redeem processes coupon redemption, returning 200 OK. Verification by querying SELECT is_redeemed, redeemed_at FROM public.UserCoupons JOIN public.Coupons ON UserCoupons.coupon_id = Coupons.coupon_id WHERE UserCoupons.unique_code = '{unique_code}' AND Coupons.business_id = '{business_id}'.

## Dev Notes
### Previous Story Insights
- Coupon sharing and wallet management are in place. [Source: docs/stories/3.5.story.md]

### Data Models
- UserCoupons table: is_redeemed, redeemed_at, unique_code. [Source: PRD]
- UserActivities table: activity_type 'coupon_redeemed', entity_id (coupon_id, business_id), activity_data (redeemed_at). [Source: PRD]

### API Specifications
- POST /api/business/{business_id}/redeem: Processes coupon redemption. [Source: PRD]
- All API interactions must go through frontend API service layer (`apps/web/src/api/`). [Source: architecture/coding-standards.md]

### Component Specifications
- Coupon redemption UI: Input/display for unique code, redemption confirmation. [Source: PRD]
- Post-redemption redirect to business storefront with review option. [Source: PRD]

### File Locations
- Frontend pages: `apps/web/src/pages/coupon-wallet.tsx`, `apps/web/src/pages/redeem-coupon.tsx`
- API service: `apps/web/src/api/redeem.ts`
- Backend: `apps/api/src/business/` (serverless functions for coupon redemption)
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Frontend: Unit and integration tests for coupon redemption and redirect UI. [Source: architecture/testing-strategy.md]
- Backend: Unit and integration tests for coupon redemption endpoints. [Source: architecture/testing-strategy.md]
- E2E: Playwright/Cypress tests for coupon redemption and check-in flows. [Source: architecture/testing-strategy.md]

### Technical Constraints
- TypeScript for all codebases. [Source: architecture/tech-stack.md]
- Follow coding standards for API service layer, error handling, and naming conventions. [Source: architecture/coding-standards.md]
- State management for coupon redemption/check-in via React Context API/Zustand/Jotai. [Source: architecture/tech-stack.md]

## Tasks / Subtasks
1. Implement coupon redemption UI for unique code entry/display and confirmation. [Source: PRD]
2. Implement backend endpoint for coupon redemption and check-in. [Source: PRD]
3. Store and update redemption/check-in data in UserCoupons and UserActivities tables. [Source: PRD]
4. Redirect user to business storefront with review option after redemption. [Source: PRD]
5. Add validation and error handling for redemption and check-in. [Source: architecture/coding-standards.md]
6. Write unit/integration tests for frontend redemption and redirect UI. [Source: architecture/testing-strategy.md]
7. Write unit/integration tests for backend redemption endpoints. [Source: architecture/testing-strategy.md]
8. Write E2E tests for coupon redemption and check-in flows. [Source: architecture/testing-strategy.md]
9. Verify all file locations and naming conventions match unified project structure. [Source: architecture/unified-project-structure.md]

## Project Structure Notes
- All files should be placed according to the unified project structure. [Source: architecture/unified-project-structure.md]
- No conflicts found between epic requirements and unified project structure.

---

Checklist: To be completed after draft review.
- [ ] All acceptance criteria addressed
- [ ] All technical context referenced
- [ ] Tasks/subtasks are actionable and referenced
- [ ] Project structure alignment verified
- [ ] Ready for developer implementation 