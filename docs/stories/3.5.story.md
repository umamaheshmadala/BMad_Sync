# Story 3.5: Gamified Coupon Sharing (User to User)

**Status:** Draft

## Story Statement
As a user,
I want to share coupons with my friends,
so that we can both benefit and I can earn "Driver" mileage.

## Acceptance Criteria
- User can select a coupon from their wallet to share with a chosen friend.
- User can share up to 3 coupons per friend per day.
- A new unique coupon instance (shared_coupon_instance_id) is created in the backend for the receiver upon sharing, fundamentally linked to the original offer and business.
- The sharer's original coupon instance (original_user_coupon_id) is marked as transferred/nullified, making it unusable by the sharer post-transfer.
- The receiver is notified of the shared coupon and can choose to accept or decline it. A shared coupon cannot be discarded without first accepting it.
- If a coupon is declined, it will be returned to the sender's wallet, and a notification will be sent to the sender about the rejection. This event will be updated in the backend database as part of the coupon's lifecycle for analytics.
- Sender can cancel a pending shared coupon before the receiver accepts it.
- A confirmation message "Share to [friends name]?" or similar is displayed before final sharing to prevent accidental sharing.
- User activity (coupon sharing) is tracked for "Driver" status calculation.
- CouponShares table is populated with original_user_coupon_id, sharer_user_id, receiver_user_id, shared_coupon_instance_id, shared_at.
- UserCoupons table current_owner_id is updated, and transfer_count is incremented for the original coupon.
- Local Testability: API endpoint POST /api/users/{user_id}/coupons/{coupon_id}/share initiates a coupon share. Verification by querying SELECT * FROM public.CouponShares WHERE sharer_user_id = '{user_id}'.
- Local Testability: API endpoint POST /api/users/{user_id}/coupons/shared/{share_id}/cancel allows sender to cancel a pending share, returning 200 OK and updating UserCoupons ownership.

## Dev Notes
### Previous Story Insights
- Friend system and activity feed are in place. [Source: docs/stories/3.4.story.md]

### Data Models
- CouponShares table: original_user_coupon_id, sharer_user_id, receiver_user_id, shared_coupon_instance_id, shared_at. [Source: PRD]
- UserCoupons table: current_owner_id, transfer_count. [Source: PRD]

### API Specifications
- POST /api/users/{user_id}/coupons/{coupon_id}/share: Initiates a coupon share. [Source: PRD]
- POST /api/users/{user_id}/coupons/shared/{share_id}/cancel: Cancels a pending share. [Source: PRD]
- All API interactions must go through frontend API service layer (`apps/web/src/api/`). [Source: architecture/coding-standards.md]

### Component Specifications
- Coupon sharing UI: Select coupon, select friend, confirm sharing. [Source: PRD]
- Notification UI for receiver and sender. [Source: PRD]
- Pending share management and cancellation UI. [Source: PRD]

### File Locations
- Frontend pages: `apps/web/src/pages/coupon-wallet.tsx`, `apps/web/src/pages/coupon-share.tsx`
- API service: `apps/web/src/api/coupon-shares.ts`
- Backend: `apps/api/src/users/` (serverless functions for coupon sharing)
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Frontend: Unit and integration tests for coupon sharing, notification, and cancellation UI. [Source: architecture/testing-strategy.md]
- Backend: Unit and integration tests for coupon sharing endpoints. [Source: architecture/testing-strategy.md]
- E2E: Playwright/Cypress tests for coupon sharing and cancellation flows. [Source: architecture/testing-strategy.md]

### Technical Constraints
- TypeScript for all codebases. [Source: architecture/tech-stack.md]
- Follow coding standards for API service layer, error handling, and naming conventions. [Source: architecture/coding-standards.md]
- State management for coupon sharing via React Context API/Zustand/Jotai. [Source: architecture/tech-stack.md]
- Coupon sharing limits and lifecycle must be enforced in backend logic. [Source: PRD]

## Tasks / Subtasks
1. Implement coupon sharing UI (select coupon, select friend, confirm sharing). [Source: PRD]
2. Implement backend endpoints for sharing and cancelling coupon shares. [Source: PRD]
3. Store and retrieve coupon sharing data in CouponShares and UserCoupons tables. [Source: PRD]
4. Implement notification UI for receiver and sender. [Source: PRD]
5. Implement pending share management and cancellation UI. [Source: PRD]
6. Enforce sharing limits and coupon lifecycle in backend. [Source: PRD]
7. Add validation and error handling for sharing and cancellation actions. [Source: architecture/coding-standards.md]
8. Write unit/integration tests for frontend sharing, notification, and cancellation UI. [Source: architecture/testing-strategy.md]
9. Write unit/integration tests for backend sharing endpoints. [Source: architecture/testing-strategy.md]
10. Write E2E tests for coupon sharing and cancellation flows. [Source: architecture/testing-strategy.md]
11. Verify all file locations and naming conventions match unified project structure. [Source: architecture/unified-project-structure.md]

## Project Structure Notes
- All files should be placed according to the unified project structure. [Source: architecture/unified-project-structure.md]
- No conflicts found between epic requirements and unified project structure.

---

Checklist: To be completed after draft review.
- [ ] All acceptance criteria addressed
- [ ] All technical context referenced
- [ ] Tasks/subtasks are actionable and referenced
- [ ] Project structure alignment verified
- [ ] Ready for developer implementation 