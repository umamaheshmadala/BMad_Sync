# Story 4.3: Business Targeted Coupon Issuance

**Status:** Draft

## Story Statement
As a business owner,
I want to issue coupons to selected demographics,
so that I can conduct bullseye marketing campaigns.

## Acceptance Criteria
- Business owner can access an interface to define targeting parameters for coupon issuance.
- Targeting parameters can be specified based on individual or a combination of: User Interests (utmost priority), Location Interests, Past behavior, Driver status (true/false), checked-in customers, businesses followers, and users who recommended or donâ€™t recommend.
- Businesses can issue exclusive coupons specifically to identified "Drivers".
- The system ensures that businesses can only target groups/categories of users, not view or target individual Driver profiles by name or personal info.
- Coupons table includes fields (e.g., target_parameters JSONB) to store the targeting criteria for each coupon issuance.
- Local Testability: API endpoint POST /api/business/coupons/issue-targeted issues coupons based on targeting, returning 200 OK. Verification by querying SELECT coupon_id, target_parameters FROM public.Coupons WHERE business_id = '{business_id}' AND target_parameters IS NOT NULL.

## Dev Notes
### Previous Story Insights
- Business analytics and coupon management are in place. [Source: docs/stories/4.1.story.md, docs/stories/3.1.story.md]

### Data Models
- Coupons table: coupon_id, business_id, target_parameters (JSONB), and other coupon fields. [Source: PRD]

### API Specifications
- POST /api/business/coupons/issue-targeted: Issues targeted coupons. [Source: PRD]
- All API interactions must go through frontend API service layer (`apps/web/src/api/`). [Source: architecture/coding-standards.md]

### Component Specifications
- Targeted coupon issuance UI: Form for selecting targeting parameters (interests, location, behavior, Driver status, etc.). [Source: PRD]
- Confirmation and summary of targeted group size. [Source: PRD]

### File Locations
- Frontend pages: `apps/web/src/pages/business-targeted-coupons.tsx`
- API service: `apps/web/src/api/targeted-coupons.ts`
- Backend: `apps/api/src/business/` (serverless functions for targeted coupon issuance)
[Source: architecture/unified-project-structure.md]

### Testing Requirements
- Frontend: Unit and integration tests for targeted coupon issuance UI. [Source: architecture/testing-strategy.md]
- Backend: Unit and integration tests for targeted coupon issuance endpoint. [Source: architecture/testing-strategy.md]
- E2E: Playwright/Cypress tests for targeted coupon issuance flows. [Source: architecture/testing-strategy.md]

### Technical Constraints
- TypeScript for all codebases. [Source: architecture/tech-stack.md]
- Follow coding standards for API service layer, error handling, and naming conventions. [Source: architecture/coding-standards.md]
- State management for targeted coupon issuance via React Context API/Zustand/Jotai. [Source: architecture/tech-stack.md]
- Targeting logic must ensure privacy and group-based targeting only. [Source: PRD]

## Tasks / Subtasks
1. Implement targeted coupon issuance UI for business owners. [Source: PRD]
2. Implement backend endpoint for targeted coupon issuance. [Source: PRD]
3. Store and retrieve targeting parameters in Coupons table. [Source: PRD]
4. Enforce group-based targeting and privacy logic in backend. [Source: PRD]
5. Add validation and error handling for targeting and issuance. [Source: architecture/coding-standards.md]
6. Write unit/integration tests for frontend targeted coupon UI. [Source: architecture/testing-strategy.md]
7. Write unit/integration tests for backend targeted coupon endpoint. [Source: architecture/testing-strategy.md]
8. Write E2E tests for targeted coupon issuance flows. [Source: architecture/testing-strategy.md]
9. Verify all file locations and naming conventions match unified project structure. [Source: architecture/unified-project-structure.md]

## Project Structure Notes
- All files should be placed according to the unified project structure. [Source: architecture/unified-project-structure.md]
- No conflicts found between epic requirements and unified project structure.

---

Checklist: To be completed after draft review.
- [ ] All acceptance criteria addressed
- [ ] All technical context referenced
- [ ] Tasks/subtasks are actionable and referenced
- [ ] Project structure alignment verified
- [ ] Ready for developer implementation 